'use strict';

var _Map = require('babel-runtime/core-js/map')['default'];

var d3 = require('d3');
var wavesControllers = require('waves-basic-controllers');
var wavesAudio = require('waves-audio');
var wavesLoaders = require('waves-loaders');
// core
var ns = require('waves-ui/dist/core/namespace');
var Timeline = require('waves-ui/dist/core/timeline');
var TimeContext = require('waves-ui/dist/core/time-context');
var Layer = require('waves-ui/dist/core/layer');
// interactions
var Event = require('waves-ui/dist/interactions/event');
var Surface = require('waves-ui/dist/interactions/surface');
var Keyboard = require('waves-ui/dist/interactions/keyboard');
// shapes
var Waveform = require('waves-ui/dist/shapes/waveform');
var Cursor = require('waves-ui/dist/shapes/cursor');
// timeline states
var BaseState = require('waves-ui/dist/timeline-states/base-state');
var SelectionState = require('waves-ui/dist/timeline-states/selection-state');
var EditionState = require('waves-ui/dist/timeline-states/edition-state');
var ContextEditionState = require('waves-ui/dist/timeline-states/context-edition-state');

// -----------------------------------------------------
// APPLICATION
// -----------------------------------------------------

var session = require('../assets/json/session.json');
// load all files
var filesSrc = './assets/sound/';
var loader = new wavesLoaders.AudioBufferLoader();
var files = [];

var width = window.innerWidth;
var height = window.innerHeight;

// dev only
//session = session.slice(0, 2);
//height = height / 3;
// populate files
session.forEach(function (track, index) {
  track.period.forEach(function (sample) {
    var file = filesSrc + sample.file;
    files.push(file);
  });
});

loader.load(files).then(function (buffers) {
  App.initialize(session);
  App.populateSession(buffers);

  App.initAudio();

  App.createAudioTracks();
  App.createCursorTrack();

  App.addTestControllers();

  App.renderTimeline();
})['catch'](function (err) {
  console.log(err.stack);
});

// application
var App = {
  initialize: function initialize(session) {
    this.session = session;
    this.globals = { currentTime: 0, duration: 60 * 2 };
    this.layerEngineMap = new _Map();

    this.timeline = new Timeline({
      duration: this.globals.duration,
      width: 800
    });

    this.$container = document.querySelector('#session-container');
    // init default state
    var selectionState = new SelectionState(this.timeline);
    var contextEditionState = new ContextEditionState(this.timeline);

    this.timeline.setState(contextEditionState);
    this.timeline.on('update', this.onTimelineUpdate.bind(this));
  },

  addTestControllers: function addTestControllers() {
    var _this = this;

    var rAFId = null;
    var that = this;

    new wavesControllers.Buttons('transport', ['start', 'stop'], '#controls', function (value) {
      switch (value) {
        case 'start':
          _this.playControl.start();

          (function loop() {
            // console.log(that.transport.currentPosition);
            that.globals.currentTime = that.transport.currentPosition;
            that.timeline.update('cursor');

            rAFId = requestAnimationFrame(loop);
          })();
          break;
        case 'stop':
          _this.playControl.stop();
          cancelAnimationFrame(rAFId);
          _this.globals.currentTime = _this.transport.currentPosition;
          break;
      }
    });

    new wavesControllers.Slider('timeline stretchRatio', 0.1, 100, 0.1, 1, '', '', '#controls', function (value) {
      _this.timeline.context.stretchRatio = value;
      _this.timeline.update();
    });

    new wavesControllers.Slider('timeline translation', -this.globals.duration, this.globals.duration, 1, 0, '', '', '#controls', function (value) {
      _this.timeline.context.offset = value;
      _this.timeline.updateContainers();
    });

    new wavesControllers.Slider('waveform zoom y', 0.1, 10, 0.1, 1, '', '', '#controls', function (value) {
      var yDomain = [-1 / value, 1 / value];
      _this.timeline.layers.forEach(function (layer) {
        layer.yDomain = yDomain;
        _this.timeline.update(layer);
      });
    });
  },

  initAudio: function initAudio() {
    this.audioContext = wavesAudio.audioContext;
    this.transport = new wavesAudio.Transport();
    this.playControl = new wavesAudio.PlayControl(this.transport);
    this.playerEngines = {};
  },
  // add the buffers into the session configuration
  populateSession: function populateSession(buffers) {
    var index = 0;

    this.session.forEach(function (track) {
      track.period.forEach(function (sample) {
        sample.buffer = buffers[index];
        index += 1;
      });
    });
  },

  audioTrackTemplate: function audioTrackTemplate(data) {
    return '<div class="controls-container">\n        <h4>' + data.label + '</h4>\n      </div>\n      <div class="svg-container"></div>';
  },

  globalTrackTemplate: function globalTrackTemplate() {
    return '<div class="controls-container"></div>\n      <div class="svg-container"></div>';
  },

  // create the DOM structure for the session and add waveforms
  createAudioTracks: function createAudioTracks() {
    var _this2 = this;

    var trackHeight = 100; //Math.min(height / this.session.length) - 1;

    // create Tracks
    this.session.forEach(function (track, index) {
      // create a track element for each track
      var $track = document.createElement('li');
      $track.setAttribute('id', 'track-' + track.id);
      $track.classList.add('track');
      $track.style.height = '' + trackHeight + 'px';

      $track.innerHTML = _this2.audioTrackTemplate(track);
      _this2.$container.appendChild($track);

      var $sampleContainer = $track.querySelector('.svg-container');
      _this2.timeline.registerContainer(track.id, $sampleContainer, { height: trackHeight });

      _this2.playerEngines[track.id] = [];

      // create waveforms
      track.period.forEach(function (sample) {
        console.log(sample);
        var layer = new Layer('entity', sample.buffer.getChannelData(0), {
          height: trackHeight,
          yDomain: [-1, 1]
        });

        layer.setShape(Waveform, {
          y: function y(d) {
            return d;
          },
          sampleRate: function sampleRate() {
            return sample.buffer.sampleRate;
          }
        });

        _this2.timeline.add(layer, track.id, 'audio-track');

        var start = sample.begin / 1000;
        var duration = sample.buffer.duration;
        var end = start + duration;

        layer.editable = true;
        layer.setContextAttribute('start', start);
        layer.setContextAttribute('duration', duration);

        // init player engine
        var engine = new wavesAudio.PlayerEngine();
        engine.buffer = sample.buffer;
        engine.connect(_this2.audioContext.destination);

        var transportedEngine = _this2.transport.add(engine);
        _this2.layerEngineMap.set(layer, transportedEngine);
      });
    });
  },

  onTimelineUpdate: function onTimelineUpdate(layers) {
    var _this3 = this;

    layers.forEach(function (layer) {
      var contextAttributes = layer.contextAttributes;
      var engine = _this3.layerEngineMap.get(layer);
      // if the layer is not associated with an engine
      if (!engine) {
        return;
      }
      var start = contextAttributes.start;
      var end = start + contextAttributes.duration;
      var offset = start + contextAttributes.offset;
      // console.log(start, end, offset);

      engine.setBoundaries(start, end, offset);
    });
  },

  // add a cursor layer
  createCursorTrack: function createCursorTrack() {
    var $track = document.createElement('li');
    $track.setAttribute('id', 'cursor-layer');
    $track.classList.add('track', 'global');

    $track.innerHTML = this.globalTrackTemplate();
    this.$container.appendChild($track);

    var $cursorContainer = $track.querySelector('.svg-container');
    this.timeline.registerContainer('cursor', $cursorContainer, { height: height });

    var cursor = new Layer('entity', this.globals, { height: height });
    cursor.setShape(Cursor, {
      x: function x(d) {
        var v = arguments[1] === undefined ? null : arguments[1];

        if (v !== null) {
          d.currentTime = v;
        }
        return d.currentTime;
      }
    }, { color: 'red' });

    this.timeline.add(cursor, 'cursor', 'cursor');
  },

  renderTimeline: function renderTimeline() {
    this.timeline.render();

    this.timeline.draw();
    this.timeline.update();

    // cursor
    var prev = new Date().getTime();
    // const that = this;

    // (function loop() {
    //   const now = new Date().getTime();
    //   const delta = (now - prev) / 1000;
    //   that.globals.currentTime += delta;
    //   that.timeline.update();
    //   prev = now;

    //   requestAnimationFrame(loop);
    // }());
  }
};
//# sourceMappingURL=data:application/json;base64,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QUFFcEMsUUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDaEUsUUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQzs7QUFFaEYsUUFBTSxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUNyRSxVQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtBQUN0QixPQUFDLEVBQUUsV0FBUyxDQUFDLEVBQVk7WUFBVixDQUFDLGdDQUFHLElBQUk7O0FBQ3JCLFlBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtBQUFFLFdBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1NBQUU7QUFDdEMsZUFBTyxDQUFDLENBQUMsV0FBVyxDQUFDO09BQ3RCO0tBQ0YsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDOztBQUVyQixRQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0dBQy9DOztBQUVELGdCQUFjLEVBQUEsMEJBQUc7QUFDZixRQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDOztBQUV2QixRQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3JCLFFBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7OztBQUd2QixRQUFJLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDOzs7Ozs7Ozs7Ozs7R0FZakM7Q0FDRixDQUFDIiwiZmlsZSI6ImVzNi9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZDMgPSByZXF1aXJlKCdkMycpO1xuY29uc3Qgd2F2ZXNDb250cm9sbGVycyA9IHJlcXVpcmUoJ3dhdmVzLWJhc2ljLWNvbnRyb2xsZXJzJyk7XG5jb25zdCB3YXZlc0F1ZGlvID0gcmVxdWlyZSgnd2F2ZXMtYXVkaW8nKTtcbmNvbnN0IHdhdmVzTG9hZGVycyA9IHJlcXVpcmUoJ3dhdmVzLWxvYWRlcnMnKTtcbi8vIGNvcmVcbmNvbnN0IG5zID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC9jb3JlL25hbWVzcGFjZScpO1xuY29uc3QgVGltZWxpbmUgPSByZXF1aXJlKCd3YXZlcy11aS9kaXN0L2NvcmUvdGltZWxpbmUnKTtcbmNvbnN0IFRpbWVDb250ZXh0ID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC9jb3JlL3RpbWUtY29udGV4dCcpO1xuY29uc3QgTGF5ZXIgPSByZXF1aXJlKCd3YXZlcy11aS9kaXN0L2NvcmUvbGF5ZXInKTtcbi8vIGludGVyYWN0aW9uc1xuY29uc3QgRXZlbnQgPSByZXF1aXJlKCd3YXZlcy11aS9kaXN0L2ludGVyYWN0aW9ucy9ldmVudCcpO1xuY29uc3QgU3VyZmFjZSA9IHJlcXVpcmUoJ3dhdmVzLXVpL2Rpc3QvaW50ZXJhY3Rpb25zL3N1cmZhY2UnKTtcbmNvbnN0IEtleWJvYXJkID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC9pbnRlcmFjdGlvbnMva2V5Ym9hcmQnKTtcbi8vIHNoYXBlc1xuY29uc3QgV2F2ZWZvcm0gPSByZXF1aXJlKCd3YXZlcy11aS9kaXN0L3NoYXBlcy93YXZlZm9ybScpO1xuY29uc3QgQ3Vyc29yID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC9zaGFwZXMvY3Vyc29yJyk7XG4vLyB0aW1lbGluZSBzdGF0ZXNcbmNvbnN0IEJhc2VTdGF0ZSA9IHJlcXVpcmUoJ3dhdmVzLXVpL2Rpc3QvdGltZWxpbmUtc3RhdGVzL2Jhc2Utc3RhdGUnKTtcbmNvbnN0IFNlbGVjdGlvblN0YXRlID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC90aW1lbGluZS1zdGF0ZXMvc2VsZWN0aW9uLXN0YXRlJyk7XG5jb25zdCBFZGl0aW9uU3RhdGUgPSByZXF1aXJlKCd3YXZlcy11aS9kaXN0L3RpbWVsaW5lLXN0YXRlcy9lZGl0aW9uLXN0YXRlJyk7XG5jb25zdCBDb250ZXh0RWRpdGlvblN0YXRlID0gcmVxdWlyZSgnd2F2ZXMtdWkvZGlzdC90aW1lbGluZS1zdGF0ZXMvY29udGV4dC1lZGl0aW9uLXN0YXRlJyk7XG5cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIEFQUExJQ0FUSU9OXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5sZXQgc2Vzc2lvbiA9IHJlcXVpcmUoJy4uL2Fzc2V0cy9qc29uL3Nlc3Npb24uanNvbicpO1xuLy8gbG9hZCBhbGwgZmlsZXNcbmNvbnN0IGZpbGVzU3JjID0gJy4vYXNzZXRzL3NvdW5kLyc7XG5jb25zdCBsb2FkZXIgPSBuZXcgd2F2ZXNMb2FkZXJzLkF1ZGlvQnVmZmVyTG9hZGVyKCk7XG5jb25zdCBmaWxlcyA9IFtdO1xuXG5sZXQgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbmxldCBoZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XG5cbi8vIGRldiBvbmx5XG4vL3Nlc3Npb24gPSBzZXNzaW9uLnNsaWNlKDAsIDIpO1xuLy9oZWlnaHQgPSBoZWlnaHQgLyAzO1xuLy8gcG9wdWxhdGUgZmlsZXNcbnNlc3Npb24uZm9yRWFjaChmdW5jdGlvbih0cmFjaywgaW5kZXgpIHtcbiAgdHJhY2sucGVyaW9kLmZvckVhY2goZnVuY3Rpb24oc2FtcGxlKSB7XG4gICAgY29uc3QgZmlsZSA9IGZpbGVzU3JjICsgc2FtcGxlLmZpbGU7XG4gICAgZmlsZXMucHVzaChmaWxlKTtcbiAgfSk7XG59KTtcblxubG9hZGVyLmxvYWQoZmlsZXMpLnRoZW4oZnVuY3Rpb24oYnVmZmVycykge1xuICBBcHAuaW5pdGlhbGl6ZShzZXNzaW9uKTtcbiAgQXBwLnBvcHVsYXRlU2Vzc2lvbihidWZmZXJzKTtcblxuICBBcHAuaW5pdEF1ZGlvKCk7XG5cbiAgQXBwLmNyZWF0ZUF1ZGlvVHJhY2tzKCk7XG4gIEFwcC5jcmVhdGVDdXJzb3JUcmFjaygpO1xuXG4gIEFwcC5hZGRUZXN0Q29udHJvbGxlcnMoKTtcblxuICBBcHAucmVuZGVyVGltZWxpbmUoKTtcbn0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICBjb25zb2xlLmxvZyhlcnIuc3RhY2spO1xufSk7XG5cbi8vIGFwcGxpY2F0aW9uXG5jb25zdCBBcHAgPSB7XG4gIGluaXRpYWxpemUoc2Vzc2lvbikge1xuICAgIHRoaXMuc2Vzc2lvbiA9IHNlc3Npb247XG4gICAgdGhpcy5nbG9iYWxzID0geyBjdXJyZW50VGltZTogMCwgZHVyYXRpb246IDYwICogMiB9O1xuICAgIHRoaXMubGF5ZXJFbmdpbmVNYXAgPSBuZXcgTWFwKCk7XG5cbiAgICB0aGlzLnRpbWVsaW5lID0gbmV3IFRpbWVsaW5lKHtcbiAgICAgIGR1cmF0aW9uOiB0aGlzLmdsb2JhbHMuZHVyYXRpb24sXG4gICAgICB3aWR0aDogODAwXG4gICAgfSk7XG5cbiAgICB0aGlzLiRjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjc2Vzc2lvbi1jb250YWluZXInKTtcbiAgICAvLyBpbml0IGRlZmF1bHQgc3RhdGVcbiAgICBjb25zdCBzZWxlY3Rpb25TdGF0ZSA9IG5ldyBTZWxlY3Rpb25TdGF0ZSh0aGlzLnRpbWVsaW5lKTtcbiAgICBjb25zdCBjb250ZXh0RWRpdGlvblN0YXRlID0gbmV3IENvbnRleHRFZGl0aW9uU3RhdGUodGhpcy50aW1lbGluZSk7XG5cbiAgICB0aGlzLnRpbWVsaW5lLnNldFN0YXRlKGNvbnRleHRFZGl0aW9uU3RhdGUpO1xuICAgIHRoaXMudGltZWxpbmUub24oJ3VwZGF0ZScsIHRoaXMub25UaW1lbGluZVVwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgfSxcblxuICBhZGRUZXN0Q29udHJvbGxlcnMoKSB7XG4gICAgbGV0IHJBRklkID0gbnVsbDtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcblxuICAgIG5ldyB3YXZlc0NvbnRyb2xsZXJzLkJ1dHRvbnMoJ3RyYW5zcG9ydCcsIFsnc3RhcnQnLCAnc3RvcCddLCAnI2NvbnRyb2xzJywgKHZhbHVlKSA9PiB7XG4gICAgICBzd2l0Y2ggKHZhbHVlKSB7XG4gICAgICAgIGNhc2UgJ3N0YXJ0JzpcbiAgICAgICAgICB0aGlzLnBsYXlDb250cm9sLnN0YXJ0KCk7XG5cbiAgICAgICAgICAoZnVuY3Rpb24gbG9vcCgpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHRoYXQudHJhbnNwb3J0LmN1cnJlbnRQb3NpdGlvbik7XG4gICAgICAgICAgICB0aGF0Lmdsb2JhbHMuY3VycmVudFRpbWUgPSB0aGF0LnRyYW5zcG9ydC5jdXJyZW50UG9zaXRpb247XG4gICAgICAgICAgICB0aGF0LnRpbWVsaW5lLnVwZGF0ZSgnY3Vyc29yJyk7XG5cbiAgICAgICAgICAgIHJBRklkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGxvb3ApO1xuICAgICAgICAgIH0oKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3N0b3AnOlxuICAgICAgICAgIHRoaXMucGxheUNvbnRyb2wuc3RvcCgpO1xuICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJBRklkKTtcbiAgICAgICAgICB0aGlzLmdsb2JhbHMuY3VycmVudFRpbWUgPSB0aGlzLnRyYW5zcG9ydC5jdXJyZW50UG9zaXRpb247XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBuZXcgd2F2ZXNDb250cm9sbGVycy5TbGlkZXIoJ3RpbWVsaW5lIHN0cmV0Y2hSYXRpbycsIDAuMSwgMTAwLCAwLjEsIDEsICcnLCAnJywgJyNjb250cm9scycsICh2YWx1ZSkgPT4ge1xuICAgICAgdGhpcy50aW1lbGluZS5jb250ZXh0LnN0cmV0Y2hSYXRpbyA9IHZhbHVlO1xuICAgICAgdGhpcy50aW1lbGluZS51cGRhdGUoKTtcbiAgICB9KTtcblxuICAgIG5ldyB3YXZlc0NvbnRyb2xsZXJzLlNsaWRlcigndGltZWxpbmUgdHJhbnNsYXRpb24nLCAtdGhpcy5nbG9iYWxzLmR1cmF0aW9uLCB0aGlzLmdsb2JhbHMuZHVyYXRpb24sIDEsIDAsICcnLCAnJywgJyNjb250cm9scycsICh2YWx1ZSkgPT4ge1xuICAgICAgdGhpcy50aW1lbGluZS5jb250ZXh0Lm9mZnNldCA9IHZhbHVlO1xuICAgICAgdGhpcy50aW1lbGluZS51cGRhdGVDb250YWluZXJzKCk7XG4gICAgfSk7XG5cbiAgICBuZXcgd2F2ZXNDb250cm9sbGVycy5TbGlkZXIoJ3dhdmVmb3JtIHpvb20geScsIDAuMSwgMTAsIDAuMSwgMSwgJycsICcnLCAnI2NvbnRyb2xzJywgKHZhbHVlKSA9PiB7XG4gICAgICBjb25zdCB5RG9tYWluID0gWy0xL3ZhbHVlLCAxL3ZhbHVlXTtcbiAgICAgIHRoaXMudGltZWxpbmUubGF5ZXJzLmZvckVhY2goKGxheWVyKSA9PiB7XG4gICAgICAgIGxheWVyLnlEb21haW4gPSB5RG9tYWluO1xuICAgICAgICB0aGlzLnRpbWVsaW5lLnVwZGF0ZShsYXllcik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcblxuICBpbml0QXVkaW8oKSB7XG4gICAgdGhpcy5hdWRpb0NvbnRleHQgPSB3YXZlc0F1ZGlvLmF1ZGlvQ29udGV4dDtcbiAgICB0aGlzLnRyYW5zcG9ydCA9IG5ldyB3YXZlc0F1ZGlvLlRyYW5zcG9ydCgpO1xuICAgIHRoaXMucGxheUNvbnRyb2wgPSBuZXcgd2F2ZXNBdWRpby5QbGF5Q29udHJvbCh0aGlzLnRyYW5zcG9ydCk7XG4gICAgdGhpcy5wbGF5ZXJFbmdpbmVzID0ge307XG4gIH0sXG4gIC8vIGFkZCB0aGUgYnVmZmVycyBpbnRvIHRoZSBzZXNzaW9uIGNvbmZpZ3VyYXRpb25cbiAgcG9wdWxhdGVTZXNzaW9uKGJ1ZmZlcnMpIHtcbiAgICBsZXQgaW5kZXggPSAwO1xuXG4gICAgdGhpcy5zZXNzaW9uLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHtcbiAgICAgIHRyYWNrLnBlcmlvZC5mb3JFYWNoKGZ1bmN0aW9uKHNhbXBsZSkge1xuICAgICAgICBzYW1wbGUuYnVmZmVyID0gYnVmZmVyc1tpbmRleF07XG4gICAgICAgIGluZGV4ICs9IDE7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcblxuICBhdWRpb1RyYWNrVGVtcGxhdGUoZGF0YSkge1xuICAgIHJldHVybiBgPGRpdiBjbGFzcz1cImNvbnRyb2xzLWNvbnRhaW5lclwiPlxuICAgICAgICA8aDQ+JHtkYXRhLmxhYmVsfTwvaDQ+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxkaXYgY2xhc3M9XCJzdmctY29udGFpbmVyXCI+PC9kaXY+YDtcbiAgfSxcblxuICBnbG9iYWxUcmFja1RlbXBsYXRlKCkge1xuICAgIHJldHVybiBgPGRpdiBjbGFzcz1cImNvbnRyb2xzLWNvbnRhaW5lclwiPjwvZGl2PlxuICAgICAgPGRpdiBjbGFzcz1cInN2Zy1jb250YWluZXJcIj48L2Rpdj5gO1xuICB9LFxuXG4gIC8vIGNyZWF0ZSB0aGUgRE9NIHN0cnVjdHVyZSBmb3IgdGhlIHNlc3Npb24gYW5kIGFkZCB3YXZlZm9ybXNcbiAgY3JlYXRlQXVkaW9UcmFja3MoKSB7XG4gICAgY29uc3QgdHJhY2tIZWlnaHQgPSAxMDA7IC8vTWF0aC5taW4oaGVpZ2h0IC8gdGhpcy5zZXNzaW9uLmxlbmd0aCkgLSAxO1xuXG4gICAgLy8gY3JlYXRlIFRyYWNrc1xuICAgIHRoaXMuc2Vzc2lvbi5mb3JFYWNoKCh0cmFjaywgaW5kZXgpID0+IHtcbiAgICAgIC8vIGNyZWF0ZSBhIHRyYWNrIGVsZW1lbnQgZm9yIGVhY2ggdHJhY2tcbiAgICAgIGNvbnN0ICR0cmFjayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG4gICAgICAkdHJhY2suc2V0QXR0cmlidXRlKCdpZCcsIGB0cmFjay0ke3RyYWNrLmlkfWApO1xuICAgICAgJHRyYWNrLmNsYXNzTGlzdC5hZGQoJ3RyYWNrJyk7XG4gICAgICAkdHJhY2suc3R5bGUuaGVpZ2h0ID0gYCR7dHJhY2tIZWlnaHR9cHhgO1xuXG4gICAgICAkdHJhY2suaW5uZXJIVE1MID0gdGhpcy5hdWRpb1RyYWNrVGVtcGxhdGUodHJhY2spO1xuICAgICAgdGhpcy4kY29udGFpbmVyLmFwcGVuZENoaWxkKCR0cmFjayk7XG5cbiAgICAgIGNvbnN0ICRzYW1wbGVDb250YWluZXIgPSAkdHJhY2sucXVlcnlTZWxlY3RvcignLnN2Zy1jb250YWluZXInKTtcbiAgICAgIHRoaXMudGltZWxpbmUucmVnaXN0ZXJDb250YWluZXIodHJhY2suaWQsICRzYW1wbGVDb250YWluZXIsIHsgaGVpZ2h0OiB0cmFja0hlaWdodCB9KTtcblxuICAgICAgdGhpcy5wbGF5ZXJFbmdpbmVzW3RyYWNrLmlkXSA9IFtdO1xuXG4gICAgICAvLyBjcmVhdGUgd2F2ZWZvcm1zXG4gICAgICB0cmFjay5wZXJpb2QuZm9yRWFjaCgoc2FtcGxlKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKHNhbXBsZSk7XG4gICAgICAgIGNvbnN0IGxheWVyID0gbmV3IExheWVyKCdlbnRpdHknLCBzYW1wbGUuYnVmZmVyLmdldENoYW5uZWxEYXRhKDApLCB7XG4gICAgICAgICAgaGVpZ2h0OiB0cmFja0hlaWdodCxcbiAgICAgICAgICB5RG9tYWluOiBbLTEsIDFdXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxheWVyLnNldFNoYXBlKFdhdmVmb3JtLCB7XG4gICAgICAgICAgeTogZnVuY3Rpb24oZCkgeyByZXR1cm4gZDsgfSxcbiAgICAgICAgICBzYW1wbGVSYXRlOiBmdW5jdGlvbigpIHsgcmV0dXJuIHNhbXBsZS5idWZmZXIuc2FtcGxlUmF0ZTsgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnRpbWVsaW5lLmFkZChsYXllciwgdHJhY2suaWQsICdhdWRpby10cmFjaycpO1xuXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gc2FtcGxlLmJlZ2luIC8gMTAwMDtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBzYW1wbGUuYnVmZmVyLmR1cmF0aW9uO1xuICAgICAgICBjb25zdCBlbmQgPSBzdGFydCArIGR1cmF0aW9uO1xuXG4gICAgICAgIGxheWVyLmVkaXRhYmxlID0gdHJ1ZTtcbiAgICAgICAgbGF5ZXIuc2V0Q29udGV4dEF0dHJpYnV0ZSgnc3RhcnQnLCBzdGFydCk7XG4gICAgICAgIGxheWVyLnNldENvbnRleHRBdHRyaWJ1dGUoJ2R1cmF0aW9uJywgZHVyYXRpb24pO1xuXG4gICAgICAgIC8vIGluaXQgcGxheWVyIGVuZ2luZVxuICAgICAgICBjb25zdCBlbmdpbmUgPSBuZXcgd2F2ZXNBdWRpby5QbGF5ZXJFbmdpbmUoKTtcbiAgICAgICAgZW5naW5lLmJ1ZmZlciA9IHNhbXBsZS5idWZmZXI7XG4gICAgICAgIGVuZ2luZS5jb25uZWN0KHRoaXMuYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgICAgICBjb25zdCB0cmFuc3BvcnRlZEVuZ2luZSA9IHRoaXMudHJhbnNwb3J0LmFkZChlbmdpbmUpO1xuICAgICAgICB0aGlzLmxheWVyRW5naW5lTWFwLnNldChsYXllciwgdHJhbnNwb3J0ZWRFbmdpbmUpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgb25UaW1lbGluZVVwZGF0ZShsYXllcnMpIHtcbiAgICBsYXllcnMuZm9yRWFjaCgobGF5ZXIpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRleHRBdHRyaWJ1dGVzID0gbGF5ZXIuY29udGV4dEF0dHJpYnV0ZXM7XG4gICAgICBjb25zdCBlbmdpbmUgPSB0aGlzLmxheWVyRW5naW5lTWFwLmdldChsYXllcik7XG4gICAgICAvLyBpZiB0aGUgbGF5ZXIgaXMgbm90IGFzc29jaWF0ZWQgd2l0aCBhbiBlbmdpbmVcbiAgICAgIGlmICghZW5naW5lKSB7IHJldHVybjsgfVxuICAgICAgY29uc3Qgc3RhcnQgPSBjb250ZXh0QXR0cmlidXRlcy5zdGFydDtcbiAgICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgY29udGV4dEF0dHJpYnV0ZXMuZHVyYXRpb247XG4gICAgICBjb25zdCBvZmZzZXQgPSBzdGFydCArIGNvbnRleHRBdHRyaWJ1dGVzLm9mZnNldDtcbiAgICAgIC8vIGNvbnNvbGUubG9nKHN0YXJ0LCBlbmQsIG9mZnNldCk7XG5cbiAgICAgIGVuZ2luZS5zZXRCb3VuZGFyaWVzKHN0YXJ0LCBlbmQsIG9mZnNldCk7XG4gICAgfSk7XG4gIH0sXG5cbiAgLy8gYWRkIGEgY3Vyc29yIGxheWVyXG4gIGNyZWF0ZUN1cnNvclRyYWNrKCkge1xuICAgIGNvbnN0ICR0cmFjayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG4gICAgJHRyYWNrLnNldEF0dHJpYnV0ZSgnaWQnLCAnY3Vyc29yLWxheWVyJyk7XG4gICAgJHRyYWNrLmNsYXNzTGlzdC5hZGQoJ3RyYWNrJywgJ2dsb2JhbCcpO1xuXG4gICAgJHRyYWNrLmlubmVySFRNTCA9IHRoaXMuZ2xvYmFsVHJhY2tUZW1wbGF0ZSgpO1xuICAgIHRoaXMuJGNvbnRhaW5lci5hcHBlbmRDaGlsZCgkdHJhY2spO1xuXG4gICAgY29uc3QgJGN1cnNvckNvbnRhaW5lciA9ICR0cmFjay5xdWVyeVNlbGVjdG9yKCcuc3ZnLWNvbnRhaW5lcicpO1xuICAgIHRoaXMudGltZWxpbmUucmVnaXN0ZXJDb250YWluZXIoJ2N1cnNvcicsICRjdXJzb3JDb250YWluZXIsIHsgaGVpZ2h0OiBoZWlnaHQgfSk7XG5cbiAgICBjb25zdCBjdXJzb3IgPSBuZXcgTGF5ZXIoJ2VudGl0eScsIHRoaXMuZ2xvYmFscywgeyBoZWlnaHQ6IGhlaWdodCB9KTtcbiAgICBjdXJzb3Iuc2V0U2hhcGUoQ3Vyc29yLCB7XG4gICAgICB4OiBmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgICBpZiAodiAhPT0gbnVsbCkgeyBkLmN1cnJlbnRUaW1lID0gdjsgfVxuICAgICAgICByZXR1cm4gZC5jdXJyZW50VGltZTtcbiAgICAgIH1cbiAgICB9LCB7IGNvbG9yOiAncmVkJyB9KTtcblxuICAgIHRoaXMudGltZWxpbmUuYWRkKGN1cnNvciwgJ2N1cnNvcicsICdjdXJzb3InKTtcbiAgfSxcblxuICByZW5kZXJUaW1lbGluZSgpIHtcbiAgICB0aGlzLnRpbWVsaW5lLnJlbmRlcigpO1xuXG4gICAgdGhpcy50aW1lbGluZS5kcmF3KCk7XG4gICAgdGhpcy50aW1lbGluZS51cGRhdGUoKTtcblxuICAgIC8vIGN1cnNvclxuICAgIGxldCBwcmV2ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgLy8gY29uc3QgdGhhdCA9IHRoaXM7XG5cbiAgICAvLyAoZnVuY3Rpb24gbG9vcCgpIHtcbiAgICAvLyAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgIC8vICAgY29uc3QgZGVsdGEgPSAobm93IC0gcHJldikgLyAxMDAwO1xuICAgIC8vICAgdGhhdC5nbG9iYWxzLmN1cnJlbnRUaW1lICs9IGRlbHRhO1xuICAgIC8vICAgdGhhdC50aW1lbGluZS51cGRhdGUoKTtcbiAgICAvLyAgIHByZXYgPSBub3c7XG5cbiAgICAvLyAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKTtcbiAgICAvLyB9KCkpO1xuICB9XG59O1xuIl19